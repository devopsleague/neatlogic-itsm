<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.techsure.balantflow.process.mapper.AttributeMapper">
	<resultMap id="dateCubeResultMap" type="com.techsure.balantflow.process.dto.DataCubeVo">
		<id column="uuid" property="uuid" />
		<result column="type" property="type" />
		<result column="name" property="name" />
		<result column="value" property="value" />
		<result column="sql" property="sql" />
		<result column="url" property="url" />
		<collection property="fieldList" ofType="com.techsure.balantflow.process.dto.DataCubeFieldVo">
			<result column="fieldName" property="name" />
		</collection>
	</resultMap>

	<select id="getDataCubeByUuid" parameterType="java.lang.String" resultMap="dateCubeResultMap">
		SELECT
		a.`uuid`,
		a.`name`,
		a.`type`,
		a.`value`,
		a.`sql`,
		a.`url`,
		b.`name` AS fieldName
		FROM
		`datacube` a LEFT JOIN `datacube_field` b
		ON a.`uuid` = b.`datacube_uuid`
		WHERE
		a.`uuid` = #{value}
	</select>

	<select id="searchAttribute" parameterType="com.techsure.balantflow.process.dto.AttributeVo" resultType="com.techsure.balantflow.process.dto.AttributeVo">
		SELECT
		`uuid`,
		`label`,
		`type`,
		`handler`,
		`unit`,
		`datacube_textfield` AS dataCubeTextField,
		`datacube_valuefield` AS dataCubeValueField,
		`datacube_uuid` AS dataCubeUuid,
		`config`,
		`description`,
		`is_active` AS isActive
		FROM
		`attribute`
		WHERE
		1=1
		<if test="label != null and label != ''">
			AND label LIKE CONCAT('%',#{label},'%')
		</if>
		<if test="handler != null and handler != ''">
			AND handler = #{handler}
		</if>
		<if test="type != null and type != ''">
			AND type = #{type}
		</if>
		<if test="isActive != null">
			AND is_active = #{isActive}
		</if>
		LIMIT #{startNum}, #{pageSize}
	</select>

	<select id="searchAttributeCount" parameterType="com.techsure.balantflow.process.dto.AttributeVo" resultType="int">
		SELECT
		COUNT(1)
		FROM
		`attribute`
		WHERE
		1=1
		<if test="label != null and label != ''">
			AND label LIKE CONCAT('%',#{label},'%')
		</if>
		<if test="handler != null and handler != ''">
			AND handler = #{handler}
		</if>
		<if test="type != null and type != ''">
			AND type = #{type}
		</if>
		<if test="isActive != null">
			AND is_active = #{isActive}
		</if>
	</select>

	<select id="getAttributeByUuid" parameterType="java.lang.String" resultType="com.techsure.balantflow.process.dto.AttributeVo">
		SELECT
		`uuid`,
		`label`,
		`type`,
		`handler`,
		`unit`,
		`datacube_textfield` AS dataCubeTextField,
		`datacube_valuefield` AS dataCubeValueField,
		`datacube_uuid` AS dataCubeUuid,
		`config`,
		`description`,
		`is_active` AS isActive,
		`edit_template` AS editTemplate,
		`view_template` AS viewTemplate,
		`config_template` AS configTemplate
		FROM
		`attribute`
		WHERE
		`uuid` = #{value}
	</select>

	<update id="resetAttributeActive">
		UPDATE `attribute` SET is_active = 0 WHERE `type` = 'system'
	</update>

	<insert id="replaceAttribute" parameterType="com.techsure.balantflow.process.dto.AttributeVo">
		REPLACE INTO `attribute` (
		`uuid`,
		`label`,
		`type`,
		`handler`,
		`unit`,
		`datacube_textfield`,
		`datacube_valuefield`,
		`datacube_uuid`,
		`config`,
		`description`,
		`is_active`,
		`edit_template`,
		`view_template`,
		`config_template`
		)
		VALUES
		(
		#{uuid},
		#{label},
		#{type},
		#{handler},
		#{unit},
		#{dataCubeTextField},
		#{dataCubeValueField},
		#{dataCubeUuid},
		#{config},
		#{description},
		#{isActive},
		#{editTemplate},
		#{viewTemplate},
		#{configTemplate}
		)
	</insert>
</mapper>